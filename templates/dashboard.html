<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shop Manager Dashboard - Live Data</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/icon-192.png') }}">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="theme-color" content="#0d6efd">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192.png') }}">
  </head>
  <body>
    <div class="app-layout">
      <aside class="sidebar" id="appSidebar" aria-label="Main navigation" style="display:none;">
        <!-- Left sidebar intentionally hidden on new mobile-first UI -->
      </aside>

      <div class="main-wrapper">
    <!-- Setup Modal -->
    <div id="setupModal" class="setup-modal">
      <div class="setup-content">
        <h3><i class="fas fa-cog me-2"></i>Google Sheets API Setup</h3>
        <p>To connect to your Google Sheets, you need to provide a Google Sheets API key.</p>

        <div class="mb-3">
          <label class="form-label">Google Sheets API Key:</label>
          <input type="text" id="apiKeyInput" class="form-control" placeholder="Enter your Google Sheets API key" />
        </div>

        <div id="connectionStatus"></div>

        <div class="d-flex justify-content-between">
          <button class="btn btn-secondary" onclick="closeSetup()">Cancel</button>
          <button class="btn btn-primary" onclick="saveSetup()">Save</button>
        </div>
      </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
      <div class="container">
        <button id="navbarHamburger" class="navbar-hamburger btn btn-link" aria-label="Toggle sidebar" aria-controls="appSidebar" aria-expanded="true">
          <i class="fas fa-bars fa-lg"></i>
        </button>
        <a class="navbar-brand" href="#"><i class="fas fa-chart-line me-2"></i>Shop Manager Dashboard</a>
        <div>
          <button id="installBtn" class="install-btn" style="display: none;" onclick="promptInstall()">
            <i class="fas fa-download me-2"></i>Install App
          </button>
        </div>
      </div>
    </nav>

  <div class="right-menu" id="rightMenu" role="menu" aria-hidden="true">
      <a href="{{ url_for('orders') }}" role="menuitem"><i class="fas fa-shopping-cart"></i> Orders</a>
      <a href="{{ url_for('workers') }}" role="menuitem"><i class="fas fa-users"></i> Workers</a>
      <a href="{{ url_for('expenses') }}" role="menuitem"><i class="fas fa-wallet"></i> Expenses</a>
  <a href="{{ url_for('mesurments_interface') }}" role="menuitem"><i class="fas fa-cut"></i> Tailor Interface</a>
      <hr class="menu-divider">
      <a href="#" role="menuitem" onclick="refreshDashboard(); return false;"><i class="fas fa-sync-alt"></i> Refresh Data</a>
      <a href="#" role="menuitem" onclick="openSetup(); return false;"><i class="fas fa-cog"></i> Setup API</a>
    </div>

    <div class="container-fluid dashboard-container" style="margin-top: 120px;">
      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-rupee-sign"></i>
          </div>
          <div class="stat-value" id="totalRevenue">₹0</div>
          <div class="stat-label">Total Revenue</div>
          <div class="trend-indicator trend-up" id="revenueTrend">
            <i class="fas fa-arrow-up"></i> +0% vs last month
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <div class="stat-value" id="totalOrders">0</div>
          <div class="stat-label">Total Orders</div>
          <div class="trend-indicator trend-up" id="ordersTrend">
            <i class="fas fa-arrow-up"></i> +0 this month
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-value" id="totalWorkers">0</div>
          <div class="stat-label">Active Workers</div>
          <div class="trend-indicator" id="workersTrend">
            <i class="fas fa-user-plus"></i> Workers registered
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="stat-value" id="monthlyProfit">₹0</div>
          <div class="stat-label">Monthly Profit</div>
          <div class="trend-indicator" id="profitTrend">
            <i class="fas fa-calculator"></i> Revenue - Expenses
          </div>
        </div>
      </div>

      <!-- Summary Boxes for Orders / Workers / Expenses -->
      <div class="row my-4">
        <div class="col-12 col-md-4">
          <a class="mini-card d-block text-decoration-none" href="{{ url_for('orders') }}">
            <div class="mini-icon"><i class="fas fa-shopping-cart"></i></div>
            <div class="mini-title">Orders</div>
            <div class="mini-value" id="ordersCardCount">0</div>
            <div class="mini-sub">View all orders</div>
          </a>
        </div>
        <div class="col-12 col-md-4">
          <a class="mini-card d-block text-decoration-none" href="{{ url_for('workers') }}">
            <div class="mini-icon"><i class="fas fa-users"></i></div>
            <div class="mini-title">Workers</div>
            <div class="mini-value" id="workersCardCount">0</div>
            <div class="mini-sub">Manage workers & payments</div>
          </a>
        </div>
        <div class="col-12 col-md-4">
          <a class="mini-card d-block text-decoration-none" href="{{ url_for('expenses') }}">
            <div class="mini-icon"><i class="fas fa-wallet"></i></div>
            <div class="mini-title">Expenses</div>
            <div class="mini-value" id="expensesCardCount">₹0</div>
            <div class="mini-sub">Track expenses</div>
          </a>
        </div>
        <div class="col-12 col-md-4">
          <a class="mini-card d-block text-decoration-none" href="{{ url_for('mesurments_interface') }}">
            <div class="mini-icon"><i class="fas fa-cut"></i></div>
            <div class="mini-title">Tailor Interface</div>
            <div class="mini-value">&nbsp;</div>
            <div class="mini-sub">Manage tailoring orders & measurements</div>
          </a>
        </div>
      </div>

      <!-- Charts Row 1 -->
      <div class="row">
        <div class="col-lg-6">
          <div class="chart-container">
            <div class="chart-title">Revenue by Order Type</div>
            <div class="chart-wrapper">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="chart-container">
            <div class="chart-title">Monthly Revenue Trend</div>
            <div class="chart-wrapper">
              <canvas id="monthlyChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row 2 -->
      <div class="row">
        <div class="col-lg-6">
          <div class="chart-container">
            <div class="chart-title">Payment Status Distribution</div>
            <div class="chart-wrapper">
              <canvas id="paymentChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="chart-container">
            <div class="chart-title">Expense Breakdown</div>
            <div class="chart-wrapper">
              <canvas id="expenseChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activities -->
      <div class="row">
        <div class="col-lg-12">
          <div class="stat-card">
            <h4 class="mb-4"><i class="fas fa-clock me-2"></i>Recent Activities</h4>
            <div id="recentActivities" class="recent-activities-content">
              <div class="activity-placeholder">
                <i class="fas fa-clock fa-2x mb-3 text-muted"></i>
                <p class="text-muted">Loading recent activities...</p>
                <small class="text-muted">Fetching latest orders and transactions</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div> <!-- .main-wrapper -->
    </div> <!-- .app-layout -->
    <script src="{{ url_for('static', filename='scripts/dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/pwa.js') }}"></script>
    <script>
      // Small helper to open setup modal if no API key saved
      document.addEventListener('DOMContentLoaded', function() {
        // Removed automatic popup - user can manually open via Setup API button
        /*
        try {
          const apiKey = localStorage.getItem('sheetsApiKey');
          if (!apiKey) {
            setTimeout(openSetup, 800);
          }
        } catch (e) {}
        */

        // Sidebar toggle
        const sidebar = document.getElementById('appSidebar');
        const toggle = document.getElementById('sidebarToggle');
        const navbarHamburger = document.getElementById('navbarHamburger');
        const sidebarHamburger = document.getElementById('sidebarHamburger');

        function toggleSidebar(trigger) {
            // On small screens, toggle a mobile-open class to slide the sidebar in/out
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            if (isMobile) {
              const isOpen = sidebar.classList.toggle('mobile-open');
              // ensure collapsed state is synced for larger screens
              if (isOpen) sidebar.classList.remove('collapsed');
              const expanded = isOpen;
              toggle && toggle.setAttribute('aria-expanded', expanded);
              navbarHamburger && navbarHamburger.setAttribute('aria-expanded', expanded);
              sidebarHamburger && sidebarHamburger.setAttribute('aria-expanded', expanded);
              if (sidebarHamburger) {
                sidebarHamburger.setAttribute('aria-label', expanded ? 'Collapse sidebar' : 'Expand sidebar');
                sidebarHamburger.title = expanded ? 'Collapse sidebar' : 'Expand sidebar';
              }
              trigger && trigger.focus();
              setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
              return;
            }

            const isCollapsed = sidebar.classList.toggle('collapsed');
            const expanded = !isCollapsed;
          // Keep aria-expanded in sync for accessibility
          toggle && toggle.setAttribute('aria-expanded', expanded);
          navbarHamburger && navbarHamburger.setAttribute('aria-expanded', expanded);
          sidebarHamburger && sidebarHamburger.setAttribute('aria-expanded', expanded);
          // Update aria-label for hamburger button
          if (sidebarHamburger) {
            sidebarHamburger.setAttribute('aria-label', expanded ? 'Collapse sidebar' : 'Expand sidebar');
            sidebarHamburger.title = expanded ? 'Collapse sidebar' : 'Expand sidebar';
          }
          // maintain focus outline for keyboard users
          trigger && trigger.focus();
          setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        }

    // Click handlers
    toggle && toggle.addEventListener('click', function() { toggleSidebar(this); });
    sidebarHamburger && sidebarHamburger.addEventListener('click', function() { toggleSidebar(this); });

    // Keyboard support: Enter or Space toggles for sidebar controls
    [toggle, sidebarHamburger].forEach(el => {
      if (!el) return;
      el.setAttribute('tabindex', '0');
      el.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleSidebar(el);
        }
      });
    });

    // Keyboard support for navbar hamburger to toggle quick menu
    if (navbarHamburger) {
      navbarHamburger.setAttribute('tabindex', '0');
      navbarHamburger.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const rightMenu = document.getElementById('rightMenu');
          if (!rightMenu) return;
          const isOpen = rightMenu.classList.toggle('open');
          rightMenu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        }
      });
    }
      });
    </script>
    
    <!-- PWA Install Prompt Script -->
    <script>
      let deferredPrompt;
      const installBtn = document.getElementById('installBtn');

      window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        // Show our install button
        installBtn.style.display = 'inline-block';
      });

      function promptInstall() {
        if (deferredPrompt) {
          // Show the prompt
          deferredPrompt.prompt();
          // Wait for the user to respond to the prompt
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
              // Hide the install button
              installBtn.style.display = 'none';
            } else {
              console.log('User dismissed the install prompt');
            }
            deferredPrompt = null;
          });
        } else {
          // Fallback for browsers that don't support PWA install
          alert('This app can be installed! Look for the install option in your browser menu or address bar.');
        }
      }

      // Hide install button if app is already installed
      window.addEventListener('appinstalled', (evt) => {
        console.log('PWA was installed');
        installBtn.style.display = 'none';
      });

      // Check if app is already installed (for browsers that support this)
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        installBtn.style.display = 'none';
      }
    </script>
    <script>
      // Right-side quick menu toggle (triggered by top-left navbar hamburger)
      (function(){
        const navbarHamburger = document.getElementById('navbarHamburger');
        const rightMenu = document.getElementById('rightMenu');
        function closeMenu(){
          if (!rightMenu) return;
          rightMenu.classList.remove('open');
          rightMenu.setAttribute('aria-hidden', 'true');
        }
        function openMenu(){
          if (!rightMenu) return;
          rightMenu.classList.add('open');
          rightMenu.setAttribute('aria-hidden', 'false');
        }
        navbarHamburger && navbarHamburger.addEventListener('click', function(e){
          if (!rightMenu) return;
          if (rightMenu.classList.contains('open')) closeMenu(); else openMenu();
        });
        // Close on outside click (exclude navbarHamburger)
        document.addEventListener('click', function(e){
          if (!rightMenu) return;
          if (rightMenu.classList.contains('open') && !rightMenu.contains(e.target) && !navbarHamburger.contains(e.target)){
            closeMenu();
          }
        }, true);
        // Close on ESC
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeMenu(); });
      })();
    </script>
  </body>
</html>
